# 
FROM python:3.10

# 
WORKDIR /code

# 
COPY ./requirements.txt /code/requirements.txt

# 
RUN pip install --no-cache-dir --upgrade -r /code/requirements.txt

# 
COPY ./app /code/app
COPY ./migration /code/migration
COPY ./alembic.ini /code/alembic.ini

# Set environment variables from arguments
ARG ENVIRONMENT
ARG POSTGRES_USER
ARG POSTGRES_PASSWORD
ARG POSTGRES_DB
ARG POSTGRES_TEST_DB
ARG POSTGRES_SERVER
ARG POSTGRES_PORT
ARG PRODUCT_SEVER_DOMAIN
ARG API_KEY
ARG TEST_MAIL
ARG TEST_PASSWORD
ARG TESTER1_UID
ARG TESTER2_UID
ARG TESTER1_MAIL
ARG TESTER1_PASSWORD
ARG TESTER2_MAIL
ARG TESTER2_PASSWORD

# Set environment variables
ENV ENVIRONMENT=${ENVIRONMENT}
ENV POSTGRES_USER=${POSTGRES_USER}
ENV POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
ENV POSTGRES_DB=${POSTGRES_DB}
ENV POSTGRES_TEST_DB=${POSTGRES_TEST_DB}
ENV POSTGRES_SERVER=${POSTGRES_SERVER}
ENV POSTGRES_PORT=${POSTGRES_PORT}
ENV PRODUCT_SEVER_DOMAIN=${PRODUCT_SEVER_DOMAIN}
ENV API_KEY=${API_KEY}
ENV TEST_MAIL=${TEST_MAIL}
ENV TEST_PASSWORD=${TEST_PASSWORD}
ENV TESTER1_UID=${TESTER1_UID}
ENV TESTER2_UID=${TESTER2_UID}
ENV TESTER1_MAIL=${TESTER1_MAIL}
ENV TESTER1_PASSWORD=${TESTER1_PASSWORD}
ENV TESTER2_MAIL=${TESTER2_MAIL}
ENV TESTER2_PASSWORD=${TESTER2_PASSWORD}

# Add wait script to the image
ADD https://github.com/ufoscout/docker-compose-wait/releases/download/2.9.0/wait /wait
RUN chmod +x /wait
